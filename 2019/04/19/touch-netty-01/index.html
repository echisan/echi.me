

<!DOCTYPE html>
<html lang="en" xmlns:v-bind="http://www.w3.org/1999/xhtml">

<head>
    <title>初悉Netty - EchisanBlog</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="author" content="John Doe">
<meta name="description" content="Netty介绍Netty核心组件
Channel
回调
Future
时间和ChannelHandler

Cha...">
<meta name="keywords" content="">

    <meta charset="utf-8">
    <meta name="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/journal.css?39067470">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons");
    (function (d) {
        var config = {
                kitId: 'dwg1tuc',
                scriptTimeout: 3000,
                async: true
            },
            h = d.documentElement, t = setTimeout(function () {
                h.className = h.className.replace(/\bwf-loading\b/g, "") + " wf-inactive";
            }, config.scriptTimeout), tk = d.createElement("script"), f = false,
            s = d.getElementsByTagName("script")[0], a;
        h.className += " wf-loading";
        tk.src = 'https://use.typekit.net/' + config.kitId + '.js';
        tk.async = true;
        tk.onload = tk.onreadystatechange = function () {
            a = this.readyState;
            if (f || a && a != "complete" && a != "loaded") return;
            f = true;
            clearTimeout(t);
            try {
                Typekit.load(config)
            } catch (e) {
            }
        };
        s.parentNode.insertBefore(tk, s)
    })(document);
</script>
<noscript>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons"/>
</noscript>
<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="EchisanBlog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>
<body>
<div id="top"></div>
<div id="app">
<div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            <a class="a-block drawer-menu-item false" href="http://example.com">
                Home
            </a>
            

            
            
            <a class="a-block drawer-menu-item false" href="/about/index.html">
                关于我
            </a>
            
            <a class="a-block drawer-menu-item false" href="/search/index.html">
                search
            </a>
            
            <a class="a-block drawer-menu-item false" href="/tags/index.html">
                tags
            </a>
            

            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            EchisanBlog
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">EchisanBlog</div>
        <div class="single-column-header-subtitle"></div>
    </a>
</div>
<div ref="sideContainer" class="side-container">
    <a class="a-block nav-head false" href="/">
        <div class="nav-title">
            Echisan.
        </div>
        <div class="nav-subtitle">
            吃西瓜不吐籽
        </div>
    </a>

    <div class="nav-link-list">
        

        
        
        <a class="a-block nav-link-item false" href="/about/index.html">
            关于我
        </a>
        
        <a class="a-block nav-link-item false" href="/search/index.html">
            search
        </a>
        
        <a class="a-block nav-link-item false" href="/tags/index.html">
            tags
        </a>
        

        
    </div>

    
    <div class="nav-footer">
        Proudly published with Hexo<br>
        
        Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
        
        &copy; 2021 <a href="http://example.com">EchisanBlog</a>
    </div>
</div>
<div ref="extraContainer" class="extra-container">
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>

        
    </div>
</div>



<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            <div class="post-head-wrapper-text-only"
                 style="background-image: url('')">
                <div class="post-title">
                    初悉Netty
                    <div class="post-meta">
                        <time datetime="2019-04-19T03:21:47.000Z" itemprop="datePublished">
                            2019-04-19 11:21
                        </time>&nbsp;
                        
    
                        
                        
                        <i class="material-icons" style="">label</i>
                        
                        <a href='/tags/netty/'>netty</a>, 
                        
                        <a href='/tags/java/'>java</a>, 
                        
                        <a href='/tags/nio/'>nio</a>
                        
                        
                    </div>
                </div>
            </div>
    
            <div class="post-body-wrapper">
                <div class="post-body">
                    <h2 id="Netty介绍"><a href="#Netty介绍" class="headerlink" title="Netty介绍"></a>Netty介绍</h2><h2 id="Netty核心组件"><a href="#Netty核心组件" class="headerlink" title="Netty核心组件"></a>Netty核心组件</h2><ul>
<li>Channel</li>
<li>回调</li>
<li>Future</li>
<li>时间和ChannelHandler</li>
</ul>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>Channel是Java NIO的一个基本构造</p>
<blockquote>
<p>它代表一个到实体(如一个硬件设备、一个文件、一个网络套接字或者一个能够执行一个或者多个不同的I/O操作的程序组件)的开放连接，如读操作和写操作 。</p>
</blockquote>
<p>目前，可以把 Channel 看作是传入(入站)或者传出(出站)数据的载体。因此，它可以被打开或者被关闭，连接或者断开连接。</p>
<h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>有点抽象的描述，用代码解释的话就是如下，当有一个新的连接已经被建立时，<code>ChannelHandler</code>的<code>channelActive()</code>回调方法将会被调用。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">@Override
public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;
    System.out.println(ctx.channel().remoteAddress());
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>如果使用过java中的Future应该知道，该对象提供的是一个异步操作，通过future.get()可以获取到该结果。</p>
<blockquote>
<p>JDK 预置了 interface java.util.concurrent.Future，但是其所提供的实现，只允许手动检查对应的操作是否已经完成，或者一直阻塞直到它完成。这是非常繁琐的，所以 Netty提供了它自己的实现——ChannelFuture，用于在执行异步操作的时候使用。</p>
</blockquote>
<h3 id="事件和ChannelHandler"><a href="#事件和ChannelHandler" class="headerlink" title="事件和ChannelHandler"></a>事件和ChannelHandler</h3><p>Netty 使用不同的事件来通知我们状态的改变或者是操作的状态。这使得我们能够基于已经<br>发生的事件来触发适当的动作。这些动作可能是:</p>
<ul>
<li>记录日志</li>
<li>数据转换</li>
<li>流控制</li>
<li>应用程序逻辑</li>
</ul>
<p>Netty 是一个网络编程框架，所以事件是按照它们与入站或出站数据流的相关性进行分类的。 可能由入站数据或者相关的状态更改而触发的事件包括: </p>
<ul>
<li>连接已被激活或者连接失活</li>
<li>数据读取</li>
<li>用户事件</li>
<li>错误事件</li>
</ul>
<p>出站事件是未来将会触发的某个动作的操作结果，这些动作包括:</p>
<ul>
<li>打开或者关闭到远程节点的连接</li>
<li>将数据写到或者冲刷到套接字</li>
</ul>
<p><img src="/images/201904/channelHandler-chain.png" alt="image-20190419122546568"></p>
<h4 id="选择器、事件和EventLoop"><a href="#选择器、事件和EventLoop" class="headerlink" title="选择器、事件和EventLoop"></a>选择器、事件和EventLoop</h4><p>Netty 通过触发事件将 Selector 从应用程序中抽象出来，消除了所有本来将需要手动编写的派发代码。在内部，将会为每个 Channel 分配一个 EventLoop，用以处理所有事件，包括:</p>
<ul>
<li>注册感兴趣的事件</li>
<li>将事件派发给ChannelHandler</li>
<li>安排进一步的动作</li>
</ul>
<blockquote>
<p>EventLoop 本身只由一个线程驱动，其处理了一个 Channel 的所有 I/O 事件，并且在该 EventLoop 的整个生命周期内都不会改变。这个简单而强大的设计消除了你可能有的在 ChannelHandler 实现中需要进行同步的任何顾虑，因此，你可以专注于提供正确的逻辑，用 来在有感兴趣的数据要处理的时候执行。 </p>
</blockquote>
<h2 id="编写Echo服务器和客户端"><a href="#编写Echo服务器和客户端" class="headerlink" title="编写Echo服务器和客户端"></a>编写Echo服务器和客户端</h2><p><img src="/images/201904/echo-client-server.png" alt="image-20190419123740192"></p>
<h3 id="编写Echo-server"><a href="#编写Echo-server" class="headerlink" title="编写Echo server"></a>编写Echo server</h3><p>所有Netty服务器都需要以下两部分</p>
<ul>
<li>至少一个ChannelHandler — 该组件实现了服务器对从客户端接收的数据的处理，即它的业务逻辑</li>
<li>引导 — 配置服务器的启动代码。至少，它会将服务器绑定到它要监听连接请求的端口上</li>
</ul>
<h4 id="ChannelHandler-和-业务逻辑"><a href="#ChannelHandler-和-业务逻辑" class="headerlink" title="ChannelHandler 和 业务逻辑"></a>ChannelHandler 和 业务逻辑</h4><blockquote>
<p><code>如果不捕获异常，会发生什么呢</code></p>
<p>每个 Channel 都拥有一个与之相关联的 ChannelPipeline，其持有一个 ChannelHandler 的 实例链。在默认的情况下，ChannelHandler 会把对它的方法的调用转发给链中的下一个 Channel- Handler。因此，如果exceptionCaught()方法没有被该链中的某处实现，那么所接收的异常将会被 传递到 ChannelPipeline 的尾端并被记录。为此，你的应用程序应该提供至少有一个实现了 exceptionCaught()方法的 ChannelHandler。 </p>
</blockquote>
<h4 id="一些关键点"><a href="#一些关键点" class="headerlink" title="一些关键点"></a>一些关键点</h4><ul>
<li>针对不同类型的事件来调用ChannelHandler</li>
<li>应用程序通过实现或扩展ChannelHandler来挂钩到事件的生命周期，并且提供自定义的应用程序逻辑</li>
<li>在架构上，ChannelHandler有助于保持业务逻辑与网络处理代码的分离。简化了开发过程，因为代码必须不断地演化已响应不断变化的需求</li>
</ul>
<h4 id="引导服务器"><a href="#引导服务器" class="headerlink" title="引导服务器"></a>引导服务器</h4><p>具体涉及的内容：</p>
<ul>
<li><p>绑定到服务器将在其上监听并接受传入连接请求的端口（中文版书上就这么写的，看完我都不懂中文了）</p>
<blockquote>
<p>其实就是绑定个端口吧，比如像是socket.bind(8080)的样子(?)</p>
</blockquote>
</li>
<li><p>配置Channel，以将有关的入站消息通知给<code>EchoServerHandler</code>实例</p>
</li>
</ul>
<h3 id="编写Echo-client"><a href="#编写Echo-client" class="headerlink" title="编写Echo client"></a>编写Echo client</h3><blockquote>
<p>SimpleChannelInboundHandler 与 ChannelInboundHandler 你可能会想:为什么我们在客户端使用的是 SimpleChannelInboundHandler，而不是在 Echo- </p>
<p>ServerHandler 中所使用的 ChannelInboundHandlerAdapter 呢?这和两个因素的相互作用有 关:业务逻辑如何处理消息以及 Netty 如何管理资源。 </p>
<p>在客户端，当 channelRead0()方法完成时，你已经有了传入消息，并且已经处理完它了。当该方 法返回时，SimpleChannelInboundHandler 负责释放指向保存该消息的 ByteBuf 的内存引用。 </p>
<p>在 EchoServerHandler 中，你仍然需要将传入消息回送给发送者，而 write()操作是异步的，直 到 channelRead()方法返回后可能仍然没有完成(如代码清单 2-1 所示)。为此，EchoServerHandler 扩展了 ChannelInboundHandlerAdapter，其在这个时间点上不会释放消息。 </p>
<p>消息在 EchoServerHandler 的 channelReadComplete()方法中，当 writeAndFlush()方 法被调用时被释放(见代码清单 2-1)。 </p>
</blockquote>
<h4 id="引导客户端"><a href="#引导客户端" class="headerlink" title="引导客户端"></a>引导客户端</h4>
                </div>
            </div>
    
            <nav class="post-pagination">
    
    <a class="newer-posts" href="/2019/04/19/Netty-component-design/">
        Previous post<br>初悉Netty的组件和设计
    </a>
    
    <span class="page-number"></span>
    
    <a class="older-posts" href="/2019/04/18/touch-nio-channel/">
        Next post<br>初悉java nio channel
    </a>
    
</nav>

    
            


        </div>
    </div>
    <div class="single-column-footer">
    Proudly published with Hexo<br>
    
    Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>
    
    &copy; 2021 <a href="http://example.com">EchisanBlog</a>
</div>
</div>

</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"
        integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"
        integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js"
        integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script>
<script src="/js/journal.js?33932280"></script>



</body>
</html>
